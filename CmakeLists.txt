cmake_minimum_required(VERSION 3.11)

project(kcShaders VERSION 1.0 LANGUAGES C CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Collect all source files
file(GLOB_RECURSE SOURCES "src/*.cpp")
file(GLOB_RECURSE HEADERS "src/*.h" "src/*.hpp")

# Find required packages
find_package(OpenGL REQUIRED)

# Find GLFW3
find_package(glfw3 REQUIRED)

# Find GLM
find_package(glm CONFIG QUIET)
if (NOT glm_FOUND)
    message(STATUS "GLM not found, downloading...")
    include(FetchContent)
    FetchContent_Declare(
        glm
        GIT_REPOSITORY https://github.com/g-truc/glm.git
        GIT_TAG        0.9.9.8
    )
    FetchContent_MakeAvailable(glm)
endif()

# Add glad for OpenGL function loading
add_library(glad ${CMAKE_SOURCE_DIR}/external/glad/src/glad.c)
target_include_directories(glad PUBLIC ${CMAKE_SOURCE_DIR}/external/glad/include)
target_link_libraries(glad PUBLIC OpenGL::GL)

# Add ImGui as a library (without add_subdirectory)
set(IMGUI_DIR ${CMAKE_SOURCE_DIR}/external/imgui)
if(EXISTS "${IMGUI_DIR}")
    set(IMGUI_SOURCES
        ${IMGUI_DIR}/imgui.cpp
        ${IMGUI_DIR}/imgui_demo.cpp
        ${IMGUI_DIR}/imgui_draw.cpp
        ${IMGUI_DIR}/imgui_tables.cpp
        ${IMGUI_DIR}/imgui_widgets.cpp
        ${IMGUI_DIR}/backends/imgui_impl_glfw.cpp
        ${IMGUI_DIR}/backends/imgui_impl_opengl3.cpp
    )
    
    add_library(imgui STATIC ${IMGUI_SOURCES})
    
    target_include_directories(imgui PUBLIC
        ${IMGUI_DIR}
        ${IMGUI_DIR}/backends
    )
    
    target_link_libraries(imgui PUBLIC glfw OpenGL::GL)
    target_compile_definitions(imgui PUBLIC IMGUI_IMPL_OPENGL_LOADER_GLAD)
else()
    message(WARNING "ImGui submodule not found. Run 'git submodule update --init --recursive'")
endif()

# OpenUSD submodule support
set(OPENUSD_DIR ${CMAKE_SOURCE_DIR}/external/openusd)
if(EXISTS "${OPENUSD_DIR}/CMakeLists.txt")
    message(STATUS "OpenUSD submodule found at ${OPENUSD_DIR} - including in build")
    # add_subdirectory(${OPENUSD_DIR} EXCLUDE_FROM_ALL)
else()
    message(STATUS "OpenUSD not found. To add it as a submodule run:")
    message(STATUS "  git submodule add https://github.com/PixarAnimationStudios/USD.git external/openusd")
    message(STATUS "  git submodule update --init --recursive")
endif()

# Create executable
add_executable(kcShaders ${SOURCES} ${HEADERS})

# Include directories
target_include_directories(kcShaders PRIVATE 
    ${CMAKE_SOURCE_DIR}/src
    ${OPENGL_INCLUDE_DIR}
)

# Link libraries
target_link_libraries(kcShaders PRIVATE 
    OpenGL::GL
    glfw
    glm::glm
    glad
    imgui
)

# Set output directory
set_target_properties(kcShaders PROPERTIES
    RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin
)

# Copy shaders to build directory
file(GLOB_RECURSE SHADER_FILES "src/shaders/*.glsl" "src/shaders/*.vert" "src/shaders/*.frag")
if(SHADER_FILES)
    file(COPY ${CMAKE_SOURCE_DIR}/src/shaders 
         DESTINATION ${CMAKE_BINARY_DIR}/bin)
endif()