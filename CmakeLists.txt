cmake_minimum_required(VERSION 3.11)

project(kcShaders VERSION 1.0 LANGUAGES C CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Ensure consistent MSVC runtime to avoid LNK4098 conflicts between static and dynamic CRT
if(MSVC)
    # USD libraries are compiled with Release CRT, so we must use /MD for all configurations
    # to avoid std::string corruption when crossing DLL boundaries
    string(REGEX REPLACE "/MDd?" "" CMAKE_C_FLAGS "${CMAKE_C_FLAGS}")
    string(REGEX REPLACE "/MTd?" "" CMAKE_C_FLAGS "${CMAKE_C_FLAGS}")
    string(REGEX REPLACE "/MDd?" "" CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_DEBUG}")
    string(REGEX REPLACE "/MTd?" "" CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_DEBUG}")
    string(REGEX REPLACE "/MDd?" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
    string(REGEX REPLACE "/MTd?" "" CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS}")
    string(REGEX REPLACE "/MDd?" "" CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG}")
    string(REGEX REPLACE "/MTd?" "" CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG}")

    # Always use /MD (Release CRT) even in Debug mode for USD compatibility
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} /MD")
    set(CMAKE_C_FLAGS_DEBUG "${CMAKE_C_FLAGS_DEBUG} /MD")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MD")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} /MD")
endif()

# Collect all source files
file(GLOB_RECURSE SOURCES "src/*.cpp")
file(GLOB_RECURSE HEADERS "src/*.h" "src/*.hpp")

# Find required packages
find_package(OpenGL REQUIRED)

# Find GLFW3
find_package(glfw3 REQUIRED)

# Find GLM
find_package(glm CONFIG QUIET)
if (NOT glm_FOUND)
    message(STATUS "GLM not found, downloading...")
    include(FetchContent)
    FetchContent_Declare(
        glm
        GIT_REPOSITORY https://github.com/g-truc/glm.git
        GIT_TAG        0.9.9.8
    )
    FetchContent_MakeAvailable(glm)
endif()

# Find USD (Pixar's Universal Scene Description)
if(DEFINED ENV{USD_ROOT})
    set(USD_ROOT_DEFAULT "$ENV{USD_ROOT}")
else()
    set(USD_ROOT_DEFAULT "")
endif()

set(USD_ROOT "${USD_ROOT_DEFAULT}" CACHE PATH "USD installation directory")

if(USD_ROOT AND EXISTS "${USD_ROOT}/include/pxr")
    message(STATUS "Found USD at ${USD_ROOT}")
    set(USD_INCLUDE_DIR "${USD_ROOT}/include")
    set(USD_LIBRARY_DIR "${USD_ROOT}/lib")
    
    # Manually configure Python paths for USD
    set(USD_PYTHON_ROOT "${USD_ROOT}/python")
    set(USD_PYTHON_INCLUDE "${USD_PYTHON_ROOT}/include")
    set(USD_PYTHON_LIB "${USD_PYTHON_ROOT}/libs/python311.lib")
    
    if(EXISTS "${USD_PYTHON_INCLUDE}" AND EXISTS "${USD_PYTHON_LIB}")
        message(STATUS "Using USD's bundled Python")
        message(STATUS "  Python Include: ${USD_PYTHON_INCLUDE}")
        message(STATUS "  Python Library: ${USD_PYTHON_LIB}")
        include_directories(${USD_PYTHON_INCLUDE})
        set(USD_PYTHON_LIBRARIES ${USD_PYTHON_LIB})
    else()
        message(WARNING "USD Python not found, trying system Python")
        find_package(Python3 REQUIRED COMPONENTS Interpreter Development)
        include_directories(${Python3_INCLUDE_DIRS})
        set(USD_PYTHON_LIBRARIES ${Python3_LIBRARIES})
    endif()
    
    # Core USD libraries needed for basic scene loading
    set(USD_LIBRARIES
        ${USD_LIBRARY_DIR}/usd_usd.lib
        ${USD_LIBRARY_DIR}/usd_usdGeom.lib
        ${USD_LIBRARY_DIR}/usd_usdShade.lib
        ${USD_LIBRARY_DIR}/usd_usdLux.lib
        ${USD_LIBRARY_DIR}/usd_sdf.lib
        ${USD_LIBRARY_DIR}/usd_tf.lib
        ${USD_LIBRARY_DIR}/usd_vt.lib
        ${USD_LIBRARY_DIR}/usd_gf.lib
        ${USD_LIBRARY_DIR}/usd_ar.lib
        ${USD_LIBRARY_DIR}/usd_plug.lib
        ${USD_LIBRARY_DIR}/usd_kind.lib
        ${USD_LIBRARY_DIR}/usd_boost.lib
        ${USD_LIBRARY_DIR}/usd_python.lib
        ${USD_LIBRARY_DIR}/tbb.lib
        ${USD_LIBRARY_DIR}/tbbmalloc.lib
    )
    
    set(USD_FOUND TRUE)
    
    # USD requires specific compiler definitions
    add_compile_definitions(
        NOMINMAX  # Prevent Windows.h from defining min/max macros
        _USE_MATH_DEFINES
        TBB_USE_DEBUG=0  # Use release TBB even in debug builds
    )
else()
    message(WARNING "USD not found at ${USD_ROOT}. USD file loading will be disabled.")
    set(USD_FOUND FALSE)
endif()

# Add glad for OpenGL function loading
add_library(glad ${CMAKE_SOURCE_DIR}/external/glad/src/glad.c)
target_include_directories(glad PUBLIC ${CMAKE_SOURCE_DIR}/external/glad/include)
target_link_libraries(glad PUBLIC OpenGL::GL)

# Add ImGui as a library (without add_subdirectory)
set(IMGUI_DIR ${CMAKE_SOURCE_DIR}/external/imgui)
if(EXISTS "${IMGUI_DIR}")
    set(IMGUI_SOURCES
        ${IMGUI_DIR}/imgui.cpp
        ${IMGUI_DIR}/imgui_demo.cpp
        ${IMGUI_DIR}/imgui_draw.cpp
        ${IMGUI_DIR}/imgui_tables.cpp
        ${IMGUI_DIR}/imgui_widgets.cpp
        ${IMGUI_DIR}/backends/imgui_impl_glfw.cpp
        ${IMGUI_DIR}/backends/imgui_impl_opengl3.cpp
    )
    
    add_library(imgui STATIC ${IMGUI_SOURCES})
    
    target_include_directories(imgui PUBLIC
        ${IMGUI_DIR}
        ${IMGUI_DIR}/backends
    )
    
    target_link_libraries(imgui PUBLIC glfw OpenGL::GL)
    target_compile_definitions(imgui PUBLIC IMGUI_IMPL_OPENGL_LOADER_GLAD)
else()
    message(WARNING "ImGui submodule not found. Run 'git submodule update --init --recursive'")
endif()

# Create executable
add_executable(kcShaders ${SOURCES} ${HEADERS})

# Include directories
target_include_directories(kcShaders PRIVATE 
    ${CMAKE_SOURCE_DIR}/src
    ${OPENGL_INCLUDE_DIR}
)

# Add USD include directories if found
if(USD_FOUND)
    target_include_directories(kcShaders PRIVATE ${USD_INCLUDE_DIR})
    target_compile_definitions(kcShaders PRIVATE 
        ENABLE_USD_SUPPORT
        GLM_ENABLE_EXPERIMENTAL  # Enable GLM experimental extensions like matrix_decompose
    )
    target_link_libraries(kcShaders PRIVATE ${USD_PYTHON_LIBRARIES})
endif()

# Link libraries
target_link_libraries(kcShaders PRIVATE 
    OpenGL::GL
    glfw
    glm::glm
    glad
    imgui
)

# Link USD libraries if found
if(USD_FOUND)
    target_link_libraries(kcShaders PRIVATE ${USD_LIBRARIES})
    # USD only provides release libraries, allow linking them in debug mode
    if(MSVC)
        target_link_options(kcShaders PRIVATE 
            $<$<CONFIG:Debug>:/NODEFAULTLIB:tbb_debug.lib>
            $<$<CONFIG:Debug>:/NODEFAULTLIB:tbbmalloc_debug.lib>
        )
    endif()
endif()